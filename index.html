<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Кибер-Рой</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, deleteDoc
        };
    </script>
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: fixed; /* Закрепляем viewport */
        }
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #000000;
            color: #00ffff;
            text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #gameWrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        #gameCanvas {
            background-color: #0a0a0a;
            border: 3px solid #08d9d6;
            box-shadow: 0 0 25px rgba(8, 217, 214, 0.7);
            border-radius: 8px;
            max-width: 100vw;
            max-height: 80vh; /* Ограничиваем высоту, чтобы влезли кнопки */
            aspect-ratio: 1 / 1;
        }
        .touch-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            width: 180px;
            margin-top: 20px;
        }
        .touch-btn {
            background-color: rgba(8, 217, 214, 0.1);
            color: #08d9d6;
            border: 2px solid #08d9d6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            user-select: none;
            text-shadow: 0 0 5px #08d9d6;
            transition: all 0.2s ease-in-out;
        }
        .touch-btn:active {
            background-color: rgba(8, 217, 214, 0.4);
            box-shadow: 0 0 15px #08d9d6;
        }
        #up { grid-column: 2; grid-row: 1; }
        #left { grid-column: 1; grid-row: 2; }
        #right { grid-column: 3; grid-row: 2; }
        #down { grid-column: 2; grid-row: 3; }

        @media (min-width: 768px) {
            .touch-controls {
                display: none;
            }
        }
        .menu-button {
             margin-top: 1rem;
             padding: 0.75rem 2.5rem;
             background-color: #08d9d6;
             color: #000;
             border-radius: 8px;
             font-weight: bold;
             transition: all 0.2s ease-in-out;
             box-shadow: 0 0 15px #08d9d6;
             text-shadow: none;
        }
        .menu-button:hover:not(:disabled) {
            background-color: #67e8f9;
            box-shadow: 0 0 25px #67e8f9;
        }
        .menu-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .sub-menu-button {
             padding: 0.5rem 2rem;
             background-color: rgba(8, 217, 214, 0.1);
             color: #08d9d6;
             border: 2px solid #08d9d6;
             border-radius: 8px;
             font-weight: bold;
             transition: all 0.2s ease-in-out;
             width: 16rem; /* 256px */
        }
        .sub-menu-button:hover {
             background-color: rgba(8, 217, 214, 0.3);
             box-shadow: 0 0 15px #08d9d6;
        }
        #backToMenuButton {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            background-color: rgba(255, 45, 117, 0.2);
            border: 1px solid #ff2d75;
            color: #ff2d75;
            z-index: 10;
        }
        #scoreContainer {
            display: flex;
            justify-content: center;
            gap: 2rem;
        }
        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .color-swatch.selected {
            border-color: #ffffff;
            box-shadow: 0 0 10px #ffffff;
            transform: scale(1.1);
        }
        .theme-swatch {
            border: 3px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 48px;
            height: 48px;
        }
        .theme-swatch.selected {
            border-color: #ffffff;
            box-shadow: 0 0 10px #ffffff;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
<div id="gameWrapper">
    <div id="mainMenu" class="text-center">
        <h1 class="text-6xl mb-2 text-cyan-400" style="text-shadow: 0 0 10px #08d9d6, 0 0 15px #08d9d6;">КИБЕР-РОЙ</h1>
        <h2 id="greetingMessage" class="text-2xl mb-4 opacity-80" style="text-shadow: 0 0 5px #00ffff;"></h2>
        
        <div id="modeSelection" class="flex flex-col items-center">
             <button id="playButton" class="menu-button text-2xl">ИГРАТЬ</button>
             <button id="pvpButton" class="menu-button text-2xl">PVP</button>
             <button id="statsButton" class="menu-button text-xl">СТАТИСТИКА</button>
             <button id="settingsButton" class="menu-button text-xl">НАСТРОЙКИ</button>
        </div>
        
        <div id="pvpModeSelection" class="hidden flex flex-col items-center mt-4 space-y-4">
            <h2 class="text-3xl mb-2">РЕЖИМ PVP</h2>
            <button data-pvp-mode="points" class="sub-menu-button">ЗА ОЧКИ</button>
            <button data-pvp-mode="race" class="sub-menu-button">ГОНКА ДРОНОВ</button>
        </div>

        <div id="difficultySelection" class="hidden flex flex-col items-center mt-4 space-y-4">
            <h2 class="text-3xl mb-2">УРОВЕНЬ СЛОЖНОСТИ</h2>
            <button data-difficulty="easy" class="sub-menu-button">ЛЕГКО</button>
            <button data-difficulty="medium" class="sub-menu-button">СРЕДНЕ</button>
            <button data-difficulty="hard" class="sub-menu-button">СЛОЖНО</button>
            <button data-difficulty="nightmare" class="sub-menu-button" style="border-color: #ff2d75; color: #ff2d75;">УЖАС</button>
        </div>

        <div id="waitingRoom" class="hidden flex-col items-center mt-4 space-y-4 p-4 border-2 border-cyan-500 rounded-lg">
            <h2 class="text-3xl mb-2">ОЖИДАНИЕ ПРОТИВНИКА</h2>
            <p>Отправьте эту ссылку второму игроку:</p>
            <input id="inviteLink" type="text" readonly class="bg-gray-800 text-center text-cyan-300 border border-cyan-500 rounded p-2 w-full max-w-sm">
            <div class="flex space-x-4">
                <button id="copyLinkButton" class="sub-menu-button !w-auto">Копировать</button>
                <button id="shareLinkButton" class="sub-menu-button !w-auto">Поделиться</button>
            </div>
             <button id="backToMainFromWaiting" class="menu-button mt-8">Назад</button>
        </div>

        <div id="connectingScreen" class="hidden flex-col items-center mt-4 space-y-4 p-4">
            <h2 class="text-3xl mb-2">ПОДКЛЮЧЕНИЕ К ИГРЕ...</h2>
        </div>

        <div id="statsMenu" class="hidden flex-col items-center mt-4 space-y-4">
            <h2 class="text-3xl mb-4">СТАТИСТИКА</h2>
            <div id="statsContainer" class="space-y-4 text-left text-lg w-full max-w-sm"></div>
            <button id="backToMainFromStatsButton" class="menu-button mt-8">Назад</button>
        </div>
        
        <div id="settingsMenu" class="hidden flex-col items-center mt-4 space-y-4">
            <h2 class="text-3xl mb-4">НАСТРОЙКИ</h2>
             <div class="flex items-center space-x-4">
                <span class="text-xl w-32 text-right">Стиль:</span>
                <div id="themeSelector" class="flex space-x-2"></div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-xl w-32 text-right">Игрок 1:</span>
                <div id="p1ColorSelector" class="flex space-x-2"></div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-xl w-32 text-right">Игрок 2:</span>
                <div id="p2ColorSelector" class="flex space-x-2"></div>
            </div>
            <button id="backToMainFromSettingsButton" class="menu-button mt-8">Назад</button>
        </div>
    </div>

    <div id="gameContainer" class="hidden relative flex-col items-center">
        <button id="backToMenuButton" class="menu-button">В меню</button>
        <h1 class="text-5xl mb-4 text-cyan-400" style="text-shadow: 0 0 8px #08d9d6, 0 0 12px #08d9d6;">КИБЕР-РОЙ</h1>
        <div class="text-center mb-4 text-lg">
            <div id="scoreContainer"></div>
            <p id="controlsHint" class="text-sm mt-2 opacity-70">(Используйте клавиши со стрелками)</p>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div id="gameOver" class="hidden text-center mt-4 p-6 bg-black/80 border-2 border-red-500 rounded-lg" style="box-shadow: 0 0 15px rgba(239, 68, 68, 0.7);">
            <h2 id="gameOverMessage" class="text-2xl text-red-500" style="text-shadow: 0 0 5px #ef4444;">СВЯЗЬ С РОЕМ ПОТЕРЯНА</h2>
            <p id="finalScoreContainer" class="mt-2 text-lg">СОБРАНО БАТАРЕЕК: <span class="text-yellow-400">0</span></p>
            <button id="restartButton" class="mt-4 px-6 py-2 bg-cyan-500 text-black rounded hover:bg-cyan-300 transition-colors font-bold" style="box-shadow: 0 0 10px #08d9d6; text-shadow: none;">
                ПЕРЕЗАПУСК
            </button>
             <p id="restart-timer-message" class="text-sm mt-2 opacity-70 hidden"></p>
        </div>
        
        <div id="touchControls" class="touch-controls">
            <div id="up" class="touch-btn">▲</div>
            <div id="left" class="touch-btn">◀</div>
            <div id="right" class="touch-btn">▶</div>
            <div id="down" class="touch-btn">▼</div>
        </div>
    </div>
</div>

    <script type="module">
        // Game elements
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameOverElement = document.getElementById('gameOver');
        const restartButton = document.getElementById('restartButton');
        const finalScoreContainer = document.getElementById('finalScoreContainer');
        const backToMenuButton = document.getElementById('backToMenuButton');
        const scoreContainer = document.getElementById('scoreContainer');
        const gameOverMessage = document.getElementById('gameOverMessage');
        const controlsHint = document.getElementById('controlsHint');
        const touchControls = document.getElementById('touchControls');
        const restartTimerMessage = document.getElementById('restart-timer-message');
        // Menu elements
        const mainMenu = document.getElementById('mainMenu');
        const gameContainer = document.getElementById('gameContainer');
        const playButton = document.getElementById('playButton');
        const pvpButton = document.getElementById('pvpButton');
        const modeSelection = document.getElementById('modeSelection');
        const pvpModeSelection = document.getElementById('pvpModeSelection');
        const difficultySelection = document.getElementById('difficultySelection');
        const settingsButton = document.getElementById('settingsButton');
        const settingsMenu = document.getElementById('settingsMenu');
        const p1ColorSelector = document.getElementById('p1ColorSelector');
        const p2ColorSelector = document.getElementById('p2ColorSelector');
        const themeSelector = document.getElementById('themeSelector');
        const backToMainFromSettingsButton = document.getElementById('backToMainFromSettingsButton');
        const greetingMessage = document.getElementById('greetingMessage');
        const statsButton = document.getElementById('statsButton');
        const statsMenu = document.getElementById('statsMenu');
        const backToMainFromStatsButton = document.getElementById('backToMainFromStatsButton');
        const waitingRoom = document.getElementById('waitingRoom');
        const connectingScreen = document.getElementById('connectingScreen');
        const inviteLink = document.getElementById('inviteLink');
        const copyLinkButton = document.getElementById('copyLinkButton');
        const shareLinkButton = document.getElementById('shareLinkButton');
        const backToMainFromWaiting = document.getElementById('backToMainFromWaiting');
        // Game settings
        const gridCells = 20;
        let gridSize;
        let swarmSpeed, battery, lastRenderTime;
        let gameActive = false;
        let difficulty, gameMode, pvpSubMode;
        
        let staticTurret, staticBullets, staticLastFireTime, staticTurretDirection;
        const staticFireRate = 5000;
        let mobileTurret, mobileTurretBullets, lastMobileFireTime, moveCounter;
        const mobileFireRate = 3500;
        const mobileMoveInterval = 8;
        
        let bonusBattery, bonusBatterySpawnTimeout, bonusBatteryDespawnTimeout;
        let animationFrameId;
        let weaponPickup, disabledStaticTurret, disabledMobileTurret, weaponSpawnTimeout;
        let p1, p2;
        const colors = ['#08d9d6', '#f97316', '#ff2d75', '#22c55e', '#a855f7'];
        let p1Color = colors[0];
        let p2Color = colors[1];
        let visualTheme = 'halloween'; // neon, military, halloween
        let obstacles = [];
        
        let gameStats = {
            easy: { wins: 0, losses: 0, dronesCollected: 0 },
            medium: { wins: 0, losses: 0, dronesCollected: 0 },
            hard: { wins: 0, losses: 0, dronesCollected: 0 },
            nightmare: { wins: 0, losses: 0, dronesCollected: 0 }
        };
        // Firebase and Online PvP
        let db, auth, userId;
        let gameId, isHost, unsubscribeGame;
        let restartTimeout;
        
        const __firebase_config = '{"apiKey":"AIzaSyAMDHzWzmgoRkk2YquyF1ZCt83qfC9oB0M","authDomain":"cyberdronesnake.firebaseapp.com","projectId":"cyberdronesnake"}';
        const BOT_USERNAME = "CyberSwarmGameBot"; 
        
        async function initializeFirebase(startParam) {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.warn("Firebase config is not set. PvP mode will be disabled.");
                    const pvpBtn = document.getElementById('pvpButton');
                    pvpBtn.disabled = true;
                    pvpBtn.title = "Настройте Firebase для активации PvP";
                    const pvpInfo = document.createElement('p');
                    pvpInfo.textContent = 'Для онлайн PvP требуется настройка Firebase в коде.';
                    pvpInfo.className = 'text-sm text-red-500 opacity-80 mt-2';
                    if (!document.querySelector('#modeSelection p')) {
                        modeSelection.appendChild(pvpInfo);
                    }
                    return;
                }
                const app = window.firebase.initializeApp(firebaseConfig);
                db = window.firebase.getFirestore(app);
                auth = window.firebase.getAuth(app);
                await window.firebase.signInAnonymously(auth);
                window.firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        if (startParam) {
                            joinGame(startParam);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert("Ошибка инициализации Firebase. Проверьте ваши ключи API в коде.");
                document.getElementById('pvpButton').disabled = true;
            }
        }
        
        async function createGame() {
            isHost = true;
            gameId = crypto.randomUUID();
            const gameRef = window.firebase.doc(db, "pvp_games", gameId);
            
            const gameData = {
                hostId: userId,
                guestId: null,
                difficulty: difficulty,
                pvpSubMode: pvpSubMode,
                status: 'waiting',
                gameState: null,
                guestInput: {x: 0, y: 0},
                hostColor: p1Color,
                guestColor: p2Color,
                hostReadyForRestart: false,
                guestReadyForRestart: false,
                theme: visualTheme
            };
            
            await window.firebase.setDoc(gameRef, gameData);
            
            const link = `https://t.me/${BOT_USERNAME}?startapp=${gameId}`;
            inviteLink.value = link;
            
            modeSelection.classList.add('hidden');
            difficultySelection.classList.add('hidden');
            pvpModeSelection.classList.add('hidden');
            waitingRoom.classList.remove('hidden');
            waitingRoom.classList.add('flex');
            
            listenToGameUpdates();
        }
        async function joinGame(gameIdFromUrl) {
            isHost = false;
            gameId = gameIdFromUrl;
            const gameRef = window.firebase.doc(db, "pvp_games", gameId);
            const gameSnap = await window.firebase.getDoc(gameRef);
            if (gameSnap.exists() && gameSnap.data().status === 'waiting') {
                await window.firebase.updateDoc(gameRef, {
                    guestId: userId,
                    status: 'active'
                });
                listenToGameUpdates();
            } else {
                alert("Игра не найдена или уже началась.");
                returnToMenu();
            }
        }
        function listenToGameUpdates() {
             if (unsubscribeGame) unsubscribeGame();
             const gameRef = window.firebase.doc(db, "pvp_games", gameId);
             unsubscribeGame = window.firebase.onSnapshot(gameRef, (doc) => {
                const data = doc.data();
                if (!data) return;
                if (data.status === 'active' && !gameActive) {
                    gameMode = 'pvp';
                    difficulty = data.difficulty;
                    pvpSubMode = data.pvpSubMode;
                    p1Color = data.hostColor;
                    p2Color = data.guestColor;
                    visualTheme = data.theme;
                    mainMenu.classList.add('hidden');
                    waitingRoom.classList.add('hidden');
                    connectingScreen.classList.add('hidden');
                    gameContainer.classList.remove('hidden');
                    gameContainer.classList.add('flex');
                    resizeCanvas();
                    
                    setupGame();
                    animationFrameId = window.requestAnimationFrame(gameLoop);
                }
                
                if (gameActive) {
                    if (isHost) {
                        if (data.guestInput && p2) {
                             p2.velocity = data.guestInput;
                        }
                    } else { // Guest logic
                        const serverState = data.gameState ? JSON.parse(data.gameState) : null;
                        if (serverState) {
                           p1 = serverState.p1;
                           if(p2) { 
                               p2.swarm = serverState.p2.swarm;
                               p2.score = serverState.p2.score;
                           }
                           battery = serverState.battery;
                           bonusBattery = serverState.bonusBattery;
                           weaponPickup = serverState.weaponPickup;
                           staticTurret = serverState.staticTurret;
                           staticBullets = serverState.staticBullets;
                           mobileTurret = serverState.mobileTurret;
                           mobileTurretBullets = serverState.mobileTurretBullets;
                           obstacles = serverState.obstacles;
                           disabledStaticTurret = serverState.disabledStaticTurret;
                           disabledMobileTurret = serverState.disabledMobileTurret;
                        }
                    }
                }
                if (data.status === 'finished') {
                    endGame(data.result);
                }
                 if (data.hostReadyForRestart && data.guestReadyForRestart) {
                     clearInterval(restartTimeout);
                     restartTimerMessage.classList.add('hidden');
                    if (isHost) {
                         window.firebase.updateDoc(gameRef, {
                            hostReadyForRestart: false,
                            guestReadyForRestart: false,
                            status: 'active'
                        });
                    }
                }
             });
        }
        function resizeCanvas() {
            const gameWrapper = document.getElementById('gameWrapper');
            const size = Math.min(gameWrapper.clientWidth, gameWrapper.clientHeight) * 0.8;
            canvas.width = size;
            canvas.height = size;
            gridSize = canvas.width / gridCells;
            if (gameActive) {
                draw();
            }
        }
        function initPlayer(x, y) {
             return {
                swarm: [{x, y}],
                velocity: {x: 0, y: 0},
                score: 0,
                weapon: null,
                weaponEndTime: 0,
                lastFireTime: 0,
                bullets: [],
                lastAteTime: Date.now(),
                changingDirection: false
             };
        }
        
        async function updateGameInFirestore() {
            if (!isHost || !gameActive) return;
            const serializableState = { p1, p2, battery, bonusBattery, weaponPickup,
                staticTurret, staticBullets, mobileTurret, mobileTurretBullets, obstacles,
                disabledStaticTurret, disabledMobileTurret };
            const gameRef = window.firebase.doc(db, "pvp_games", gameId);
            try {
                await window.firebase.updateDoc(gameRef, { gameState: JSON.stringify(serializableState) });
            } catch (e) { console.error("Update error", e)}
        }
        async function sendInputToFirestore(velocity) {
            if (isHost || !gameActive || !p2) return;
            p2.velocity = velocity;
            const gameRef = window.firebase.doc(db, "pvp_games", gameId);
            await window.firebase.updateDoc(gameRef, { guestInput: velocity });
        }
        
        async function setRestartReady() {
            restartButton.disabled = true;
            const gameRef = window.firebase.doc(db, "pvp_games", gameId);
            const fieldToUpdate = isHost ? { hostReadyForRestart: true } : { guestReadyForRestart: true };
            await window.firebase.updateDoc(gameRef, fieldToUpdate);
            
            restartTimerMessage.classList.remove('hidden');
            let countdown = 60;
            restartTimerMessage.textContent = `Ожидание второго игрока... (${countdown})`;
            restartTimeout = setInterval(async () => {
                countdown--;
                restartTimerMessage.textContent = `Ожидание второго игрока... (${countdown})`;
                if (countdown <= 0) {
                    clearInterval(restartTimeout);
                    restartTimerMessage.textContent = 'Игрок не ответил. Вернитесь в меню.';
                }
            }, 1000);
        }
        function gameLoop(currentTime) {
            if (!gameActive) return;
            animationFrameId = window.requestAnimationFrame(gameLoop);
            
            if (gameMode === 'pvp' && !isHost) {
                draw();
                return;
            }
            const secondsSinceLastRender = (currentTime - lastRenderTime) / 1000;
            if (secondsSinceLastRender < 1 / swarmSpeed) return;
            lastRenderTime = currentTime;
            
            if (p1) p1.changingDirection = false;
            if (p2) p2.changingDirection = false;
            
            update();
            draw();
            
            if (gameMode === 'pvp' && isHost) {
                updateGameInFirestore();
            }
        }
        
        function changeDirection(event) {
            if (!gameActive) return;
            const keyPressed = event.key.toLowerCase();
            let player;
            let isGuestControl = false;
            if (gameMode === 'single') {
                player = p1;
            } else if (gameMode === 'pvp') {
                if (isHost) {
                    player = p1;
                } else {
                    player = p2;
                    isGuestControl = true;
                }
            }
            if (!player || player.changingDirection) return;
            let newVelocity = null;
            const { velocity } = player;
            const goingUp = velocity.y === -1, goingDown = velocity.y === 1, goingRight = velocity.x === 1;
            const isP1Controls = ['arrowup', 'arrowdown', 'arrowleft', 'arrowright'].includes(keyPressed);
            const isP2Controls = ['w', 's', 'a', 'd'].includes(keyPressed);

            if ((isHost && isP1Controls) || (gameMode === 'single' && isP1Controls)) {
                if (keyPressed === "arrowup" && !goingDown) newVelocity = { x: 0, y: -1 };
                if (keyPressed === "arrowdown" && !goingUp) newVelocity = { x: 0, y: 1 };
                if (keyPressed === "arrowleft" && !goingRight) newVelocity = { x: -1, y: 0 };
                if (keyPressed === "arrowright" && (velocity.x !== -1)) newVelocity = { x: 1, y: 0 };
            } else if (!isHost && isP2Controls) {
                if (keyPressed === "w" && !goingDown) newVelocity = { x: 0, y: -1 };
                if (keyPressed === "s" && !goingUp) newVelocity = { x: 0, y: 1 };
                if (keyPressed === "a" && !goingRight) newVelocity = { x: -1, y: 0 };
                if (keyPressed === "d" && (velocity.x !== -1)) newVelocity = { x: 1, y: 0 };
            }

            if (newVelocity) {
                player.changingDirection = true;
                if (isGuestControl) {
                    sendInputToFirestore(newVelocity);
                } else {
                    player.velocity = newVelocity;
                }
            }
        }
        function setupGame(){
            let occupiedPositions=[];
            p1=initPlayer(4,10);
            occupiedPositions.push({...p1.swarm[0]});
            if("pvp"===gameMode){
                p2=initPlayer(gridCells-5,10);
                occupiedPositions.push({...p2.swarm[0]});
                const p1Label = pvpSubMode === 'race' ? "ДРОНЫ ИГРОКА 1" : "ОЧКИ ИГРОКА 1";
                const p2Label = pvpSubMode === 'race' ? "ДРОНЫ ИГРОКА 2" : "ОЧКИ ИГРОКА 2";
                const p1StartValue = pvpSubMode === 'race' ? p1.swarm.length : p1.score;
                const p2StartValue = pvpSubMode === 'race' ? p2.swarm.length : p2.score;
                scoreContainer.innerHTML = `
                    <p>${p1Label}: <span id="score1" style="color: ${p1Color}; text-shadow: 0 0 5px ${p1Color};">${p1StartValue}</span></p>
                    <p>${p2Label}: <span id="score2" style="color: ${p2Color}; text-shadow: 0 0 5px ${p2Color};">${p2StartValue}</span></p>
                `;
                 controlsHint.textContent = "(P1: Стрелки | P2: WASD)";
            } else {
                p2=null;
                scoreContainer.innerHTML='<p>ОЧКИ: <span id="score1" class="text-yellow-400">0</span></p>';
                controlsHint.textContent="(Используйте клавиши со стрелками)";
            }
            staticTurret=null;
            mobileTurret=null;
            obstacles=[];
            if("medium"===difficulty||"hard"===difficulty||"nightmare"===difficulty){
                const newTurret = spawnStaticTurret(occupiedPositions);
                staticTurret = newTurret.turret;
                staticTurretDirection = newTurret.direction;
                occupiedPositions.push({x:staticTurret.x,y:staticTurret.y});
            }
            if("hard"===difficulty||"nightmare"===difficulty){
                 let mobileX, mobileY;
                do {
                    mobileX = Math.floor(Math.random() * gridCells);
                    mobileY = Math.floor(Math.random() * gridCells);
                } while (occupiedPositions.some(pos => pos.x === mobileX && pos.y === mobileY));
                mobileTurret = { x: mobileX, y: mobileY };
                occupiedPositions.push({x:mobileTurret.x,y:mobileTurret.y});
            }
            if("nightmare"===difficulty){
                for(let i=0;i<3;i++){
                    let obstaclePos;
                    do { 
                        obstaclePos = { x: Math.floor(Math.random() * gridCells), y: Math.floor(Math.random() * gridCells) };
                    } while (occupiedPositions.some(pos => pos.x === obstaclePos.x && pos.y === obstaclePos.y));
                    obstacles.push(obstaclePos);
                    occupiedPositions.push(obstaclePos);
                }
            }
            swarmSpeed=9;
            gameActive=true;
            gameOverElement.classList.add("hidden");
            touchControls.classList.remove("hidden");
            staticBullets=[];
            staticLastFireTime=Date.now();
            mobileTurretBullets=[];
            lastMobileFireTime=Date.now();
            moveCounter=0;
            battery={};
            bonusBattery=null;
            clearTimeout(bonusBatterySpawnTimeout);
            clearTimeout(bonusBatteryDespawnTimeout);
            scheduleNextBonusBattery();
            weaponPickup=null;
            disabledStaticTurret=null;
            disabledMobileTurret=null;
            clearTimeout(weaponSpawnTimeout);
            if("easy"!==difficulty) scheduleNextWeapon();
            generateBattery();
        }
        function spawnStaticTurret(e){let t,o,s;do{switch(Math.floor(4*Math.random())){case 0:t=Math.floor(Math.random()*gridCells),o=0,s={x:0,y:1};break;case 1:t=gridCells-1,o=Math.floor(Math.random()*gridCells),s={x:-1,y:0};break;case 2:t=Math.floor(Math.random()*gridCells),o=gridCells-1,s={x:0,y:-1};break;case 3:t=0,o=Math.floor(Math.random()*gridCells),s={x:1,y:0}}}while(e.some(e=>e.x===t&&e.y===o));return{turret:{x:t,y:o},direction:s}}
        function scheduleNextBonusBattery(){bonusBatterySpawnTimeout=setTimeout(spawnBonusBattery,1e4*Math.random()+5e3)}
        function spawnBonusBattery(){if(gameActive&&!bonusBattery){bonusBattery=getUnoccupiedPosition();bonusBatteryDespawnTimeout=setTimeout(despawnBonusBattery,2e3*Math.random()+3e3)}}
        function despawnBonusBattery(){bonusBattery=null;if(gameActive)scheduleNextBonusBattery()}
        function scheduleNextWeapon(){weaponSpawnTimeout=setTimeout(spawnWeapon,1e4*Math.random()+1e4)}
        function spawnWeapon(){if(gameActive&&!weaponPickup){const e=["weak","medium","strong"];weaponPickup=getUnoccupiedPosition();weaponPickup.type=e[Math.floor(Math.random()*e.length)]}}
        function update(){updatePlayer(p1);if(p2)updatePlayer(p2);let e=p1.swarm.length>0?p1.swarm[0]:null;if("pvp"===gameMode&&mobileTurret&&p1.swarm.length>0&&p2&&p2.swarm.length>0){const t=Math.abs(p1.swarm[0].x-mobileTurret.x)+Math.abs(p1.swarm[0].y-mobileTurret.y),o=Math.abs(p2.swarm[0].x-mobileTurret.x)+Math.abs(p2.swarm[0].y-mobileTurret.y);if(o<t)e=p2.swarm[0]}if(disabledStaticTurret&&Date.now()>disabledStaticTurret.respawnTime){const t=[...p1.swarm,...p2?p2.swarm:[],battery,mobileTurret,weaponPickup,bonusBattery,...obstacles].filter(Boolean);const o=spawnStaticTurret(t);staticTurret=o.turret;staticTurretDirection=o.direction;disabledStaticTurret=null}if(disabledMobileTurret&&Date.now()>disabledMobileTurret.respawnTime){mobileTurret=getUnoccupiedPosition();disabledMobileTurret=null}if(staticTurret&&Date.now()-staticLastFireTime>staticFireRate){staticBullets.push({x:staticTurret.x+staticTurretDirection.x,y:staticTurret.y+staticTurretDirection.y,vx:staticTurretDirection.x,vy:staticTurretDirection.y});staticLastFireTime=Date.now()}for(let t=staticBullets.length-1;t>=0;t--){const o=staticBullets[t];o.x+=o.vx;o.y+=o.vy;if(o.x<0||o.x>=gridCells||o.y<0||o.y>=gridCells||obstacles.some(e=>e.x===o.x&&e.y===o.y))staticBullets.splice(t,1)}if(mobileTurret&&e){moveCounter++;if(moveCounter>mobileMoveInterval){moveCounter=0;const t=e.x-mobileTurret.x,o=e.y-mobileTurret.y;if(Math.abs(t)>Math.abs(o))mobileTurret.x+=Math.sign(t);else mobileTurret.y+=Math.sign(o)}if(Date.now()-lastMobileFireTime>mobileFireRate){const t=e.x-mobileTurret.x,o=e.y-mobileTurret.y;let s=0,l=0;if(Math.abs(t)>Math.abs(o))s=Math.sign(t);else l=Math.sign(o);mobileTurretBullets.push({x:mobileTurret.x+s,y:mobileTurret.y+l,vx:s,vy:l});lastMobileFireTime=Date.now()}}for(let t=mobileTurretBullets.length-1;t>=0;t--){const o=mobileTurretBullets[t];o.x+=o.vx;o.y+=o.vy;if(o.x<0||o.x>=gridCells||o.y<0||o.y>=gridCells||obstacles.some(e=>e.x===o.x&&e.y===o.y))mobileTurretBullets.splice(t,1)}if("single"===gameMode&&p1.score>=20)return void endGame({p1Won:true});const t=checkPlayerCollision(p1),o=p2?checkPlayerCollision(p2):false;if(t||o)return void endGame({p1Crashed:t,p2Crashed:o});if("pvp"===gameMode&&"race"===pvpSubMode){if(p1.swarm.length>=20)return void endGame({p1WonRace:true});if(p2.swarm.length>=20)return void endGame({p2WonRace:true})}const s=document.getElementById("score1");if(s)s.textContent="pvp"===gameMode&&"race"===pvpSubMode?p1.swarm.length:p1.score;if(p2){const t=document.getElementById("score2");if(t)t.textContent="race"===pvpSubMode?p2.swarm.length:p2.score}}
        function updatePlayer(e){if(!e.swarm||0===e.swarm.length)return;const t={x:e.swarm[0].x+e.velocity.x,y:e.swarm[0].y+e.velocity.y};e.swarm.unshift(t);let o=false;if(bonusBattery&&t.x===bonusBattery.x&&t.y===bonusBattery.y){o=true;if("nightmare"===difficulty)e.lastAteTime=Date.now();e.swarm.push({...e.swarm[e.swarm.length-1]});if("single"===gameMode)gameStats[difficulty].dronesCollected+=2;if("pvp"!==gameMode||"points"===pvpSubMode)e.score+=2;bonusBattery=null;clearTimeout(bonusBatteryDespawnTimeout);scheduleNextBonusBattery()}if(t.x===battery.x&&t.y===battery.y){o=true;if("nightmare"===difficulty)e.lastAteTime=Date.now();if("single"===gameMode)gameStats[difficulty].dronesCollected+=1;if("pvp"!==gameMode||"points"===pvpSubMode)e.score++;generateBattery()}if(!o)e.swarm.pop();if(weaponPickup&&t.x===weaponPickup.x&&t.y===weaponPickup.y){e.weapon=weaponPickup.type;e.weaponEndTime=Date.now()+5e3;weaponPickup=null;clearTimeout(weaponSpawnTimeout);scheduleNextWeapon()}if(e.weapon&&Date.now()>e.weaponEndTime)e.weapon=null;if("nightmare"===difficulty&&e.swarm.length>1&&Date.now()-e.lastAteTime>4e3){e.swarm.pop();e.lastAteTime=Date.now()}if(e.weapon&&(0!==e.velocity.x||0!==e.velocity.y)){let t=0;switch(e.weapon){case"weak":t=2e3;break;case"medium":t=1500;break;case"strong":t=1e3}if(Date.now()-e.lastFireTime>t){e.bullets.push({x:e.swarm[0].x+e.velocity.x,y:e.swarm[0].y+e.velocity.y,vx:e.velocity.x,vy:e.velocity.y});e.lastFireTime=Date.now()}}for(let t=e.bullets.length-1;t>=0;t--){const o=e.bullets[t];o.x+=o.vx;o.y+=o.vy;if(o.x<0||o.x>=gridCells||o.y<0||o.y>=gridCells||obstacles.some(e=>e.x===o.x&&e.y===o.y)){e.bullets.splice(t,1);continue}let s=false;if(staticTurret&&o.x===staticTurret.x&&o.y===staticTurret.y){disabledStaticTurret={respawnTime:Date.now()+1e4};staticTurret=null;s=true}if(mobileTurret&&o.x===mobileTurret.x&&o.y===mobileTurret.y){disabledMobileTurret={respawnTime:Date.now()+1e4};mobileTurret=null;s=true}if(s){if("pvp"!==gameMode||"points"===pvpSubMode)e.score+=4;e.bullets.splice(t,1)}}}
        function checkPlayerCollision(e){if(!e||0===e.swarm.length)return false;const t=e.swarm[0];if(t.x<0||t.x>=gridCells||t.y<0||t.y>=gridCells)return true;for(let o=1;o<e.swarm.length;o++)if(t.x===e.swarm[o].x&&t.y===e.swarm[o].y)return true;if(mobileTurret&&t.x===mobileTurret.x&&t.y===mobileTurret.y)return true;for(const o of staticBullets)if(t.x===o.x&&t.y===o.y)return true;for(const o of mobileTurretBullets)if(t.x===o.x&&t.y===o.y)return true;for(const o of obstacles)if(t.x===o.x&&t.y===o.y)return true;return false}
        // ... (The entire "draw" function and its theme helpers will be here) ...
        function draw(){switch(visualTheme){case"military":drawMilitaryTheme();break;case"halloween":drawHalloweenTheme();break;default:drawNeonTheme()}}
        function drawNeonTheme(){drawNeonBackground();if(obstacles.length>0)obstacles.forEach(e=>drawThemedObstacle(e.x*gridSize,e.y*gridSize));if(battery)drawThemedBattery(battery.x*gridSize,battery.y*gridSize);if(bonusBattery)drawThemedBonusBattery(bonusBattery.x*gridSize,bonusBattery.y*gridSize);if(weaponPickup)drawThemedWeaponPickup(weaponPickup.x*gridSize,weaponPickup.y*gridSize,weaponPickup.type);if(p1)p1.swarm.forEach((e,t)=>drawThemedDrone("p1",e.x*gridSize,e.y*gridSize,p1Color,0===t));if(p2)p2.swarm.forEach((e,t)=>drawThemedDrone("p2",e.x*gridSize,e.y*gridSize,p2Color,0===t));if(p1)p1.bullets.forEach(e=>drawThemedPlayerBullet(e.x*gridSize,e.y*gridSize));if(p2)p2.bullets.forEach(e=>drawThemedPlayerBullet(e.x*gridSize,e.y*gridSize));if(staticTurret){drawThemedStaticTurret(staticTurret.x*gridSize,staticTurret.y*gridSize,staticTurretDirection);staticBullets.forEach(e=>drawThemedTurretBullet("static",e.x*gridSize,e.y*gridSize))}if(mobileTurret){drawThemedMobileTurret(mobileTurret.x*gridSize,mobileTurret.y*gridSize);mobileTurretBullets.forEach(e=>drawThemedTurretBullet("mobile",e.x*gridSize,e.y*gridSize))}}
        function drawMilitaryTheme(){drawMilitaryBackground();if(obstacles.length>0)obstacles.forEach(e=>drawThemedObstacle(e.x*gridSize,e.y*gridSize));if(battery)drawThemedBattery(battery.x*gridSize,battery.y*gridSize);if(bonusBattery)drawThemedBonusBattery(bonusBattery.x*gridSize,bonusBattery.y*gridSize);if(weaponPickup)drawThemedWeaponPickup(weaponPickup.x*gridSize,weaponPickup.y*gridSize,weaponPickup.type);if(p1)p1.swarm.forEach((e,t)=>drawThemedDrone("p1",e.x*gridSize,e.y*gridSize,p1Color,0===t));if(p2)p2.swarm.forEach((e,t)=>drawThemedDrone("p2",e.x*gridSize,e.y*gridSize,p2Color,0===t));if(p1)p1.bullets.forEach(e=>drawThemedPlayerBullet(e.x*gridSize,e.y*gridSize));if(p2)p2.bullets.forEach(e=>drawThemedPlayerBullet(e.x*gridSize,e.y*gridSize));if(staticTurret){drawThemedStaticTurret(staticTurret.x*gridSize,staticTurret.y*gridSize,staticTurretDirection);staticBullets.forEach(e=>drawThemedTurretBullet("static",e.x*gridSize,e.y*gridSize))}if(mobileTurret){drawThemedMobileTurret(mobileTurret.x*gridSize,mobileTurret.y*gridSize);mobileTurretBullets.forEach(e=>drawThemedTurretBullet("mobile",e.x*gridSize,e.y*gridSize))}}
        function drawHalloweenTheme(){drawHalloweenBackground();if(obstacles.length>0)obstacles.forEach(e=>drawThemedObstacle(e.x*gridSize,e.y*gridSize));if(battery)drawThemedBattery(battery.x*gridSize,battery.y*gridSize);if(bonusBattery)drawThemedBonusBattery(bonusBattery.x*gridSize,bonusBattery.y*gridSize);if(weaponPickup)drawThemedWeaponPickup(weaponPickup.x*gridSize,weaponPickup.y*gridSize,weaponPickup.type);if(p1)p1.swarm.forEach((e,t)=>drawThemedDrone("p1",e.x*gridSize,e.y*gridSize,p1Color,0===t));if(p2)p2.swarm.forEach((e,t)=>drawThemedDrone("p2",e.x*gridSize,e.y*gridSize,p2Color,0===t));if(p1)p1.bullets.forEach(e=>drawThemedPlayerBullet(e.x*gridSize,e.y*gridSize));if(p2)p2.bullets.forEach(e=>drawThemedPlayerBullet(e.x*gridSize,e.y*gridSize));if(staticTurret){drawThemedStaticTurret(staticTurret.x*gridSize,staticTurret.y*gridSize,staticTurretDirection);staticBullets.forEach(e=>drawThemedTurretBullet("static",e.x*gridSize,e.y*gridSize))}if(mobileTurret){drawThemedMobileTurret(mobileTurret.x*gridSize,mobileTurret.y*gridSize);mobileTurretBullets.forEach(e=>drawThemedTurretBullet("mobile",e.x*gridSize,e.y*gridSize))}}
        function drawNeonBackground(){ctx.fillStyle="#000";ctx.fillRect(0,0,canvas.width,canvas.height)}
        function drawMilitaryBackground(){ctx.fillStyle="#5F5341";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#534736";ctx.fillRect(canvas.width*.1,canvas.height*.2,5,5);ctx.fillRect(canvas.width*.8,canvas.height*.7,5,5);ctx.fillStyle="#6B5B49";ctx.fillRect(canvas.width*.3,canvas.height*.6,5,5);ctx.fillRect(canvas.width*.6,canvas.height*.1,5,5)}
        function drawHalloweenBackground(){ctx.fillStyle="#1a0d21";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="rgba(200,200,255,0.2)";ctx.beginPath();ctx.arc(canvas.width*.2,canvas.height*.3,2,0,2*Math.PI);ctx.fill();ctx.beginPath();ctx.arc(canvas.width*.7,canvas.height*.8,1.5,0,2*Math.PI);ctx.fill();ctx.beginPath();ctx.arc(canvas.width*.9,canvas.height*.1,1,0,2*Math.PI);ctx.fill()}
        function drawThemedObstacle(e,t){switch(visualTheme){case"military":ctx.fillStyle="#696969",ctx.fillRect(e,t,gridSize,gridSize),ctx.fillStyle="#808080",ctx.fillRect(e+gridSize/4,t+gridSize/4,gridSize/2,gridSize/2);break;case"halloween":ctx.fillStyle="#605268",ctx.fillRect(e+gridSize/4,t+gridSize/5,gridSize/2,gridSize-gridSize/5),ctx.beginPath(),ctx.moveTo(e+gridSize/4,t+gridSize/5),ctx.lineTo(e+gridSize/2,t),ctx.lineTo(e+3*gridSize/4,t+gridSize/5),ctx.closePath(),ctx.fill();break;default:ctx.fillStyle="#4b5563",ctx.shadowColor="#9ca3af",ctx.shadowBlur=10,ctx.fillRect(e,t,gridSize,gridSize),ctx.shadowBlur=0}}
        function drawThemedBattery(e,t){switch(visualTheme){case"military":ctx.fillStyle="#8B0000",ctx.fillRect(e+gridSize/4,t+gridSize/4,gridSize/2,gridSize/2),ctx.fillStyle="#A9A9A9",ctx.fillRect(e+gridSize/3,t+gridSize/8,gridSize/3,gridSize/4);break;case"halloween":const o=["#FFC107","#FF5722","#4CAF50","#9C27B0"];ctx.fillStyle=o[Math.floor(Date.now()/500)%o.length],ctx.beginPath(),ctx.arc(e+gridSize/2,t+gridSize/2,gridSize/3,0,2*Math.PI),ctx.fill();break;default:ctx.shadowColor="#f59e0b",ctx.shadowBlur=15,ctx.fillStyle="#f59e0b",ctx.fillRect(e+5,t+2,gridSize-10,gridSize-4),ctx.fillStyle="#fbbf24",ctx.fillRect(e+7,t,gridSize-14,2),ctx.shadowBlur=0}}
        function drawThemedBonusBattery(e,t){switch(visualTheme){case"military":ctx.fillStyle="#00008B",ctx.fillRect(e+gridSize/4,t+gridSize/4,gridSize/2,gridSize/2),ctx.fillStyle="#ADD8E6",ctx.fillRect(e+gridSize/3,t+gridSize/8,gridSize/3,gridSize/4);break;case"halloween":const o=["#03A9F4","#2196F3","#00BCD4"];ctx.fillStyle=o[Math.floor(Date.now()/500)%o.length],ctx.beginPath(),ctx.arc(e+gridSize/2,t+gridSize/2,gridSize/3,0,2*Math.PI),ctx.fill();break;default:ctx.shadowColor="#3b82f6",ctx.shadowBlur=15,ctx.fillStyle="#3b82f6";const s=e+gridSize/2,l=t+gridSize/2;ctx.beginPath(),ctx.arc(s,l,gridSize/2.5,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#93c5fd",ctx.fillRect(s-gridSize/8,l-gridSize/4,gridSize/4,gridSize/2),ctx.fillRect(s-gridSize/4,l-gridSize/8,gridSize/2,gridSize/4),ctx.shadowBlur=0}}
        function drawThemedWeaponPickup(e,t,o){switch(visualTheme){case"military":ctx.fillStyle="#FFD700",ctx.fillRect(e+gridSize/4,t+gridSize/4,gridSize/2,gridSize/2);break;case"halloween":ctx.fillStyle="#FFFFFF",ctx.beginPath(),ctx.arc(e+gridSize/2,t+gridSize/2,gridSize/3,0,2*Math.PI),ctx.fill();break;default:let s;switch(o){case"weak":s="#22c55e";break;case"medium":s="#eab308";break;case"strong":s="#ef4444"}ctx.fillStyle=s,ctx.shadowColor=s,ctx.shadowBlur=15;const l=e+gridSize/2,n=t+gridSize/2;ctx.beginPath(),ctx.moveTo(l,n-gridSize/3),ctx.lineTo(l+gridSize/3,n+gridSize/6),ctx.lineTo(l-gridSize/3,n+gridSize/6),ctx.closePath(),ctx.fill(),ctx.shadowBlur=0}}
        function drawThemedDrone(e,t,o,s,l){switch(visualTheme){case"military":ctx.fillStyle=l?"#A9A9A9":"#808080",ctx.beginPath(),ctx.ellipse(t+gridSize/2,o+gridSize/2,gridSize/3,gridSize/2.2,0,0,2*Math.PI),ctx.fill(),ctx.fillStyle=s,ctx.beginPath(),ctx.arc(t+gridSize/2,o+gridSize/2,gridSize/5,0,2*Math.PI),ctx.fill();break;case"halloween":ctx.fillStyle="#FF8C00",ctx.beginPath(),ctx.arc(t+gridSize/2,o+gridSize/2,gridSize/2.1,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#562a00",ctx.fillRect(t+gridSize/2.5,o-gridSize/10,gridSize/5,gridSize/4),ctx.fillStyle="black",l&&(ctx.fillStyle="yellow",ctx.shadowColor="yellow",ctx.shadowBlur=5),ctx.beginPath(),ctx.moveTo(t+gridSize/4,o+gridSize/3),ctx.lineTo(t+gridSize/2.5,o+gridSize/2),ctx.lineTo(t+gridSize/4,o+2*gridSize/3),ctx.fill(),ctx.beginPath(),ctx.moveTo(t+3*gridSize/4,o+gridSize/3),ctx.lineTo(t+gridSize/1.7,o+gridSize/2),ctx.lineTo(t+3*gridSize/4,o+2*gridSize/3),ctx.fill(),ctx.shadowBlur=0;break;default:drawDrone(t,o,s,l)}}
        function drawThemedPlayerBullet(e,t){switch(visualTheme){case"military":ctx.fillStyle="#FFA500",ctx.beginPath(),ctx.arc(e+gridSize/2,t+gridSize/2,gridSize/5,0,2*Math.PI),ctx.fill();break;case"halloween":ctx.fillStyle="white",ctx.beginPath(),ctx.arc(e+gridSize/2,t+gridSize/2,gridSize/5,0,2*Math.PI),ctx.fill();break;default:ctx.fillStyle="#f0fdf4",ctx.shadowColor="#f0fdf4",ctx.shadowBlur=10,ctx.beginPath(),ctx.arc(e+gridSize/2,t+gridSize/2,gridSize/5,0,2*Math.PI),ctx.fill(),ctx.shadowBlur=0}}
        function drawThemedStaticTurret(e,t,o){switch(visualTheme){case"military":ctx.fillStyle="#696969",ctx.fillRect(e,t,gridSize,gridSize);const s=e+gridSize/2,l=t+gridSize/2;ctx.fillStyle="#404040",ctx.beginPath(),ctx.moveTo(s,l),ctx.lineTo(s+o.x*gridSize,l+o.y*gridSize),ctx.lineWidth=gridSize/4,ctx.strokeStyle="#404040",ctx.stroke(),ctx.lineWidth=1;break;case"halloween":ctx.fillStyle="#504A4B",ctx.fillRect(e,t,gridSize,gridSize),ctx.fillStyle="#403A3B",ctx.fillRect(e+gridSize/8,t+gridSize/8,gridSize-gridSize/4,gridSize-gridSize/4);break;default:const n="#ff2d75";ctx.fillStyle=n,ctx.shadowColor=n,ctx.shadowBlur=15,ctx.fillRect(e,t,gridSize,gridSize),1===o.x?ctx.fillRect(e,t+gridSize/4,1.5*gridSize,gridSize/2):-1===o.x?ctx.fillRect(e-gridSize/2,t+gridSize/4,1.5*gridSize,gridSize/2):1===o.y?ctx.fillRect(e+gridSize/4,t,.5*gridSize,1.5*gridSize):-1===o.y&&ctx.fillRect(e+gridSize/4,t-gridSize/2,.5*gridSize,1.5*gridSize),ctx.shadowBlur=0}}
        function drawThemedMobileTurret(e,t){switch(visualTheme){case"military":ctx.fillStyle="#8FBC8F",ctx.fillRect(e,t,gridSize,gridSize),ctx.fillStyle="#556B2F",ctx.beginPath(),ctx.arc(e+gridSize/2,t+gridSize/2,gridSize/3,0,2*Math.PI),ctx.fill();break;case"halloween":ctx.globalAlpha=.8,ctx.fillStyle="white",ctx.beginPath(),ctx.arc(e+gridSize/2,t+gridSize-gridSize/4,gridSize/2.5,0,2*Math.PI),ctx.fill(),ctx.fillRect(e+gridSize/2-gridSize/2.5,t,gridSize/1.25,gridSize),ctx.fillStyle="black",ctx.beginPath(),ctx.arc(e+gridSize/2.5,t+gridSize/2.5,gridSize/8,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(e+gridSize-gridSize/2.5,t+gridSize/2.5,gridSize/8,0,2*Math.PI),ctx.fill(),ctx.globalAlpha=1;break;default:const o="#a855f7";ctx.fillStyle=o,ctx.shadowColor=o,ctx.shadowBlur=15,ctx.beginPath(),ctx.arc(e+gridSize/2,t+gridSize/2,gridSize/2.5,0,2*Math.PI),ctx.fill(),ctx.shadowBlur=0}}
        function drawThemedTurretBullet(e,t,o){switch(visualTheme){case"military":ctx.fillStyle="#FF4500",ctx.beginPath(),ctx.arc(t+gridSize/2,o+gridSize/2,gridSize/4,0,2*Math.PI),ctx.fill();break;case"halloween":ctx.fillStyle="#ffeb3b",ctx.beginPath(),ctx.moveTo(t+gridSize/2,o+gridSize/4),ctx.lineTo(t+gridSize-gridSize/4,o+gridSize-gridSize/4),ctx.lineTo(t+gridSize/4,o+gridSize-gridSize/4),ctx.closePath(),ctx.fill();break;default:const s="static"===e?gridSize/3:gridSize/4;ctx.beginPath(),ctx.arc(t+gridSize/2,o+gridSize/2,s,0,2*Math.PI),ctx.fill()}}
        function getUnoccupiedPosition(){let e;const t=[...p1.swarm,...p2?p2.swarm:[],battery,weaponPickup,bonusBattery,...obstacles];if(staticTurret)t.push(staticTurret);if(mobileTurret)t.push(mobileTurret);do{e={x:Math.floor(Math.random()*gridCells),y:Math.floor(Math.random()*gridCells)}}while(t.some(t=>t&&t.x===e.x&&t.y===e.y));return e}
        function generateBattery(){const e=getUnoccupiedPosition();battery.x=e.x;battery.y=e.y}
        function endGame(e={}){if (!gameActive) return;
        gameActive=false;touchControls.classList.add("hidden");if("single"===gameMode){e.p1Won?gameStats[difficulty].wins++:gameStats[difficulty].losses++;saveStats();gameOverMessage.textContent=e.p1Won?"ПОБЕДА!":"СВЯЗЬ С РОЕМ ПОТЕРЯНА";gameOverMessage.style.color=e.p1Won?"#22c55e":"#ef4444";finalScoreContainer.innerHTML=`ОЧКИ: <span class="text-yellow-400">${p1.score}</span>`;finalScoreContainer.classList.remove("hidden")}else if("pvp"===gameMode){if (isHost) { const gameRef = window.firebase.doc(db, "pvp_games", gameId); window.firebase.updateDoc(gameRef, { status: 'finished', result: e, gameState: null }); } if("points"===pvpSubMode){let t=0;p1.score>p2.score?t=1:p2.score>p1.score&&(t=2);if(0===t){gameOverMessage.textContent="НИЧЬЯ!";gameOverMessage.style.color="#ffffff"}else{gameOverMessage.textContent=`ИГРОК ${t} ПОБЕДИЛ!`;gameOverMessage.style.color=1===t?p1Color:p2Color}finalScoreContainer.innerHTML=`\n                        Очки Игрока 1: <span style="color: ${p1Color};">${p1.score}</span> | \n                        Очки Игрока 2: <span style="color: ${p2Color};">${p2.score}</span>\n                    `}else{let t=0;e.p1WonRace?t=1:e.p2WonRace?t=2:e.p1Crashed&&!e.p2Crashed?t=2:e.p2Crashed&&!e.p1Crashed?t=1:e.p1Crashed&&e.p2Crashed&&(gameOverMessage.textContent="НИЧЬЯ!",gameOverMessage.style.color="#ffffff");if(0!==t){gameOverMessage.textContent=`ИГРОК ${t} ПОБЕДИЛ!`;gameOverMessage.style.color=1===t?p1Color:p2Color}finalScoreContainer.innerHTML=`\n                        Дроны Игрока 1: <span style="color: ${p1Color};">${p1.swarm.length}</span> | \n                        Дроны Игрока 2: <span style="color: ${p2Color};">${p2.swarm.length}</span>\n                    `}finalScoreContainer.classList.remove("hidden")}gameOverElement.classList.remove("hidden");clearTimeout(bonusBatterySpawnTimeout);clearTimeout(bonusBatteryDespawnTimeout);clearTimeout(weaponSpawnTimeout);window.cancelAnimationFrame(animationFrameId); restartButton.disabled = false;}
        function setupTouchControls(){const e=document.getElementById("up"),t=document.getElementById("down"),o=document.getElementById("left"),s=document.getElementById("right");const l=(l,n)=>{l.preventDefault();if(!gameActive||!p1||p1.changingDirection)return;let i=null;const a=p1.velocity.y===-1,r=p1.velocity.y===1,d=p1.velocity.x===1,c=()=>p1.velocity.x===-1;if("up"===n&&!r)i={x:0,y:-1};else if("down"===n&&!a)i={x:0,y:1};else if("left"===n&&!d)i={x:-1,y:0};else if("right"===n&&!c())i={x:1,y:0};if(i){p1.changingDirection=true;p1.velocity=i}};["touchstart","mousedown"].forEach(n=>{e.addEventListener(n,e=>l(e,"up"));t.addEventListener(n,e=>l(e,"down"));o.addEventListener(n,e=>l(e,"left"));s.addEventListener(n,e=>l(e,"right"))})}
        function returnToMenu(){gameActive=false;if(animationFrameId)window.cancelAnimationFrame(animationFrameId);clearTimeout(bonusBatterySpawnTimeout);clearTimeout(bonusBatteryDespawnTimeout);clearTimeout(weaponSpawnTimeout);gameContainer.classList.add("hidden");gameContainer.classList.remove("flex");mainMenu.classList.remove("hidden");modeSelection.classList.remove("hidden");difficultySelection.classList.add("hidden");pvpModeSelection.classList.add("hidden");settingsMenu.classList.add("hidden");statsMenu.classList.add("hidden");gameOverElement.classList.add("hidden")}
        const debounce=(e,t)=>{let o;return function(...s){clearTimeout(o);o=setTimeout(()=>e.apply(this,s),t)}};
        function saveStats(){try{localStorage.setItem("cyberSwarmStats",JSON.stringify(gameStats))}catch(e){console.error("Failed to save stats to localStorage",e)}}
        function displayStats(){const e=document.getElementById("statsContainer");e.innerHTML="";const t={easy:"Легко",medium:"Средне",hard:"Сложно",nightmare:"Ужас"};for(const o in t){const s=gameStats[o];const l=document.createElement("div");l.className="w-full mb-2";l.innerHTML=`\n                    <div class="flex justify-between items-center">\n                        <span class="font-bold">${t[o]}:</span>\n                        <div class="text-right">\n                            <span class="text-green-500">Побед: ${s.wins}</span>\n                            <span class="text-gray-500 ml-2">Поражений: ${s.losses}</span>\n                        </div>\n                    </div>\n                    <div class="text-right text-sm opacity-80 text-cyan-400">\n                        Всего дронов собрано: ${s.dronesCollected}\n                    </div>\n                `;e.appendChild(l)}}
        playButton.addEventListener("click",()=>{gameMode="single";modeSelection.classList.add("hidden");difficultySelection.classList.remove("hidden")});
        pvpButton.addEventListener("click",()=>{gameMode="pvp";modeSelection.classList.add("hidden");pvpModeSelection.classList.remove("hidden")});
        pvpModeSelection.addEventListener("click",e=>{"BUTTON"===e.target.tagName&&(pvpSubMode=e.target.dataset.pvpMode,pvpModeSelection.classList.add("hidden"),difficultySelection.classList.remove("hidden"))});
        difficultySelection.addEventListener("click",e=>{"BUTTON"===e.target.tagName&&(difficulty=e.target.dataset.difficulty,"pvp"===gameMode?createGame():(mainMenu.classList.add("hidden"),gameContainer.classList.remove("hidden"),gameContainer.classList.add("flex"),resizeCanvas(),setupGame(),animationFrameId=window.requestAnimationFrame(gameLoop)))});
        settingsButton.addEventListener("click",()=>{modeSelection.classList.add("hidden");settingsMenu.classList.remove("hidden");settingsMenu.classList.add("flex"); populateThemeSelector();});
        statsButton.addEventListener("click",()=>{modeSelection.classList.add("hidden");displayStats();statsMenu.classList.remove("hidden");statsMenu.classList.add("flex")});
        backToMainFromSettingsButton.addEventListener("click",()=>{settingsMenu.classList.add("hidden");settingsMenu.classList.remove("flex");modeSelection.classList.remove("hidden")});
        backToMainFromStatsButton.addEventListener("click",()=>{statsMenu.classList.add("hidden");statsMenu.classList.remove("flex");modeSelection.classList.remove("hidden")});
        backToMainFromWaiting.addEventListener('click', () => {
             if (unsubscribeGame) unsubscribeGame();
             if (isHost && gameId) {
                const gameRef = window.firebase.doc(db, "pvp_games", gameId);
                window.firebase.deleteDoc(gameRef);
             }
            returnToMenu();
        });
        copyLinkButton.addEventListener('click', () => {
            const textToCopy = inviteLink.value;
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                copyLinkButton.textContent = "Скопировано!";
            } catch (err) {
                copyLinkButton.textContent = "Ошибка!";
            }
            document.body.removeChild(textArea);
            setTimeout(() => copyLinkButton.textContent = "Копировать", 2000);
        });

        shareLinkButton.addEventListener('click', () => {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(inviteLink.value)}&text=${encodeURIComponent("Сразимся в Кибер-Рой?")}`);
            }
        });
        function populateColorSelectors(){const e=(t,o)=>{t.innerHTML="";colors.forEach(s=>{const l=document.createElement("div");l.className="color-swatch";l.style.backgroundColor=s;l.dataset.color=s;if(1===o&&s===p1Color||2===o&&s===p2Color)l.classList.add("selected");l.addEventListener("click",()=>{if(1===o)p1Color=s;else p2Color=s;Array.from(t.children).forEach(e=>e.classList.remove("selected"));l.classList.add("selected")});t.appendChild(l)})};e(p1ColorSelector,1);e(p2ColorSelector,2)}
        function populateThemeSelector(){const themes=[{id:"halloween",name:"ХЭЛЛОУИН"},{id:"military",name:"МИЛИТАРИ"},{id:"neon",name:"НЕОН"}];themeSelector.innerHTML="";themes.forEach(theme=>{const wrapper=document.createElement("div");wrapper.className="theme-swatch";wrapper.dataset.theme=theme.id;const previewCanvas=document.createElement("canvas");previewCanvas.width=48,previewCanvas.height=48;const pctx=previewCanvas.getContext("2d");drawThemePreview(pctx,theme.id);wrapper.appendChild(previewCanvas),theme.id===visualTheme&&wrapper.classList.add("selected"),wrapper.addEventListener("click",()=>{visualTheme=theme.id,Array.from(themeSelector.children).forEach(child=>child.classList.remove("selected")),wrapper.classList.add("selected");try{localStorage.setItem("cyberSwarmTheme",visualTheme)}catch(e){console.error("Failed to save theme",e)}}),themeSelector.appendChild(wrapper)})}
        function drawThemePreview(pctx,themeId){pctx.clearRect(0,0,48,48);switch(themeId){case"neon":pctx.fillStyle="#0a0a0a",pctx.fillRect(0,0,48,48),pctx.fillStyle="#08d9d6",pctx.fillRect(19,19,10,10),pctx.fillStyle="rgba(255, 255, 255, 0.9)",pctx.beginPath(),pctx.arc(24,24,4,0,2*Math.PI),pctx.fill();break;case"military":pctx.fillStyle="#556B2F",pctx.fillRect(0,0,48,48),pctx.fillStyle="#6B4423",pctx.fillRect(0,30,48,3),pctx.fillStyle="#BDB76B",pctx.beginPath(),pctx.arc(12,18,6,0,2*Math.PI),pctx.fill(),pctx.fillStyle="#808000",pctx.fillRect(30,30,12,12);break;case"halloween":pctx.fillStyle="#2c1338",pctx.fillRect(0,0,48,48),pctx.fillStyle="#ff7900",pctx.beginPath(),pctx.arc(24,24,10,0,2*Math.PI),pctx.fill(),pctx.fillStyle="black",pctx.fillRect(18,18,5,5),pctx.fillRect(25,18,5,5)}}
        restartButton.addEventListener("click",()=>{if("pvp"===gameMode)setRestartReady();else{setupGame();animationFrameId=window.requestAnimationFrame(gameLoop)}});
        backToMenuButton.addEventListener("click",returnToMenu);
        window.addEventListener("load",()=>{
            let startParam = null;
            try{const e=localStorage.getItem("cyberSwarmStats");if(e){const t=JSON.parse(e);for(const o in gameStats)if(t[o]){gameStats[o].wins=t[o].wins||0;gameStats[o].losses=t[o].losses||0;gameStats[o].dronesCollected=t[o].dronesCollected||0}}}catch(e){console.error("Failed to load stats from localStorage",e)}
            try{ const savedTheme = localStorage.getItem('cyberSwarmTheme'); if(savedTheme) visualTheme = savedTheme;} catch(e){}
            try {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                if (tg.initDataUnsafe) {
                    if (tg.initDataUnsafe.start_param) {
                        startParam = tg.initDataUnsafe.start_param;
                        mainMenu.classList.add('hidden');
                        connectingScreen.classList.remove('hidden');
                        connectingScreen.classList.add('flex');
                    }
                    if (tg.initDataUnsafe.user && tg.initDataUnsafe.user.first_name) {
                        const name = tg.initDataUnsafe.user.first_name.replace(/</g,"&lt;").replace(/>/g,"&gt;");
                        greetingMessage.innerHTML=`Привет, <span style="color: #67e8f9;">${name}</span>!`;
                    } else {
                        greetingMessage.classList.add('hidden');
                    }
                }
            } catch (e) {
                console.error("Telegram WebApp script error:", e);
            }
            
            resizeCanvas();
            initializeFirebase(startParam);
        });
        window.addEventListener("resize",debounce(resizeCanvas,100));
        // Prevent pull-to-refresh
        document.body.addEventListener('touchmove', function(event) {
            event.preventDefault();
        }, { passive: false });
        populateColorSelectors();
        setupTouchControls();
        document.addEventListener("keydown",changeDirection);
    </script>
</body>
</html>

