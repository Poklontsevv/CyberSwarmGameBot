<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Кибер-Рой</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, deleteDoc
        };
    </script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #000000;
            color: #00ffff;
            text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #gameWrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        #gameCanvas {
            background-color: #0a0a0a;
            border: 3px solid #08d9d6;
            box-shadow: 0 0 25px rgba(8, 217, 214, 0.7);
            border-radius: 8px;
            max-width: 100vw;
            max-height: 80vh; /* Ограничиваем высоту, чтобы влезли кнопки */
            aspect-ratio: 1 / 1;
        }
        .touch-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            width: 180px;
            margin-top: 20px;
        }
        .touch-btn {
            background-color: rgba(8, 217, 214, 0.1);
            color: #08d9d6;
            border: 2px solid #08d9d6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            user-select: none;
            text-shadow: 0 0 5px #08d9d6;
            transition: all 0.2s ease-in-out;
        }
        .touch-btn:active {
            background-color: rgba(8, 217, 214, 0.4);
            box-shadow: 0 0 15px #08d9d6;
        }
        #up { grid-column: 2; grid-row: 1; }
        #left { grid-column: 1; grid-row: 2; }
        #right { grid-column: 3; grid-row: 2; }
        #down { grid-column: 2; grid-row: 3; }

        @media (min-width: 768px) {
            .touch-controls {
                display: none;
            }
        }
        .menu-button {
             margin-top: 1rem;
             padding: 0.75rem 2.5rem;
             background-color: #08d9d6;
             color: #000;
             border-radius: 8px;
             font-weight: bold;
             transition: all 0.2s ease-in-out;
             box-shadow: 0 0 15px #08d9d6;
             text-shadow: none;
        }
        .menu-button:hover:not(:disabled) {
            background-color: #67e8f9;
            box-shadow: 0 0 25px #67e8f9;
        }
        .menu-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .sub-menu-button {
             padding: 0.5rem 2rem;
             background-color: rgba(8, 217, 214, 0.1);
             color: #08d9d6;
             border: 2px solid #08d9d6;
             border-radius: 8px;
             font-weight: bold;
             transition: all 0.2s ease-in-out;
             width: 16rem; /* 256px */
        }
        .sub-menu-button:hover {
             background-color: rgba(8, 217, 214, 0.3);
             box-shadow: 0 0 15px #08d9d6;
        }
        #backToMenuButton {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            background-color: rgba(255, 45, 117, 0.2);
            border: 1px solid #ff2d75;
            color: #ff2d75;
            z-index: 10;
        }
        #scoreContainer {
            display: flex;
            justify-content: center;
            gap: 2rem;
        }
        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.2s ease;
        }
        .color-swatch.selected {
            border-color: #ffffff;
            box-shadow: 0 0 10px #ffffff;
        }
    </style>
</head>
<body>
<div id="gameWrapper">
    <div id="mainMenu" class="text-center">
        <h1 class="text-6xl mb-2 text-cyan-400" style="text-shadow: 0 0 10px #08d9d6, 0 0 15px #08d9d6;">КИБЕР-РОЙ</h1>
        <h2 id="greetingMessage" class="text-2xl mb-4 opacity-80" style="text-shadow: 0 0 5px #00ffff;"></h2>
        
        <div id="modeSelection" class="flex flex-col items-center">
             <button id="playButton" class="menu-button text-2xl">ИГРАТЬ</button>
             <button id="pvpButton" class="menu-button text-2xl">PVP</button>
             <button id="statsButton" class="menu-button text-xl">СТАТИСТИКА</button>
             <button id="settingsButton" class="menu-button text-xl">НАСТРОЙКИ</button>
        </div>
        
        <div id="pvpModeSelection" class="hidden flex flex-col items-center mt-4 space-y-4">
            <h2 class="text-3xl mb-2">РЕЖИМ PVP</h2>
            <button data-pvp-mode="points" class="sub-menu-button">ЗА ОЧКИ</button>
            <button data-pvp-mode="race" class="sub-menu-button">ГОНКА ДРОНОВ</button>
        </div>

        <div id="difficultySelection" class="hidden flex flex-col items-center mt-4 space-y-4">
            <h2 class="text-3xl mb-2">УРОВЕНЬ СЛОЖНОСТИ</h2>
            <button data-difficulty="easy" class="sub-menu-button">ЛЕГКО</button>
            <button data-difficulty="medium" class="sub-menu-button">СРЕДНЕ</button>
            <button data-difficulty="hard" class="sub-menu-button">СЛОЖНО</button>
            <button data-difficulty="nightmare" class="sub-menu-button" style="border-color: #ff2d75; color: #ff2d75;">УЖАС</button>
        </div>

        <div id="waitingRoom" class="hidden flex-col items-center mt-4 space-y-4 p-4 border-2 border-cyan-500 rounded-lg">
            <h2 class="text-3xl mb-2">ОЖИДАНИЕ ПРОТИВНИКА</h2>
            <p>Отправьте эту ссылку второму игроку:</p>
            <input id="inviteLink" type="text" readonly class="bg-gray-800 text-center text-cyan-300 border border-cyan-500 rounded p-2 w-full max-w-sm">
            <div class="flex space-x-4">
                <button id="copyLinkButton" class="sub-menu-button !w-auto">Копировать</button>
                <button id="shareLinkButton" class="sub-menu-button !w-auto">Поделиться</button>
            </div>
             <button id="backToMainFromWaiting" class="menu-button mt-8">Назад</button>
        </div>

        <div id="statsMenu" class="hidden flex-col items-center mt-4 space-y-4">
            <h2 class="text-3xl mb-4">СТАТИСТИКА</h2>
            <div id="statsContainer" class="space-y-4 text-left text-lg w-full max-w-sm"></div>
            <button id="backToMainFromStatsButton" class="menu-button mt-8">Назад</button>
        </div>
        
        <div id="settingsMenu" class="hidden flex-col items-center mt-4 space-y-4">
            <h2 class="text-3xl mb-4">НАСТРОЙКИ ЦВЕТА</h2>
            <div class="flex items-center space-x-4">
                <span class="text-xl w-32 text-right">Игрок 1:</span>
                <div id="p1ColorSelector" class="flex space-x-2"></div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-xl w-32 text-right">Игрок 2:</span>
                <div id="p2ColorSelector" class="flex space-x-2"></div>
            </div>
            <button id="backToMainFromSettingsButton" class="menu-button mt-8">Назад</button>
        </div>
    </div>

    <div id="gameContainer" class="hidden relative flex-col items-center">
        <button id="backToMenuButton" class="menu-button">В меню</button>
        <h1 class="text-5xl mb-4 text-cyan-400" style="text-shadow: 0 0 8px #08d9d6, 0 0 12px #08d9d6;">КИБЕР-РОЙ</h1>
        <div class="text-center mb-4 text-lg">
            <div id="scoreContainer"></div>
            <p id="controlsHint" class="text-sm mt-2 opacity-70">(Используйте клавиши со стрелками)</p>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div id="gameOver" class="hidden text-center mt-4 p-6 bg-black/80 border-2 border-red-500 rounded-lg" style="box-shadow: 0 0 15px rgba(239, 68, 68, 0.7);">
            <h2 id="gameOverMessage" class="text-2xl text-red-500" style="text-shadow: 0 0 5px #ef4444;">СВЯЗЬ С РОЕМ ПОТЕРЯНА</h2>
            <p id="finalScoreContainer" class="mt-2 text-lg">СОБРАНО БАТАРЕЕК: <span class="text-yellow-400">0</span></p>
            <button id="restartButton" class="mt-4 px-6 py-2 bg-cyan-500 text-black rounded hover:bg-cyan-300 transition-colors font-bold" style="box-shadow: 0 0 10px #08d9d6; text-shadow: none;">
                ПЕРЕЗАПУСК
            </button>
             <p id="restart-timer-message" class="text-sm mt-2 opacity-70 hidden"></p>
        </div>
        
        <div id="touchControls" class="touch-controls">
            <div id="up" class="touch-btn">▲</div>
            <div id="left" class="touch-btn">◀</div>
            <div id="right" class="touch-btn">▶</div>
            <div id="down" class="touch-btn">▼</div>
        </div>
    </div>
</div>

    <script type="module">
        // Game elements
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameOverElement = document.getElementById('gameOver');
        const restartButton = document.getElementById('restartButton');
        const finalScoreContainer = document.getElementById('finalScoreContainer');
        const backToMenuButton = document.getElementById('backToMenuButton');
        const scoreContainer = document.getElementById('scoreContainer');
        const gameOverMessage = document.getElementById('gameOverMessage');
        const controlsHint = document.getElementById('controlsHint');
        const touchControls = document.getElementById('touchControls');
        const restartTimerMessage = document.getElementById('restart-timer-message');

        // Menu elements
        const mainMenu = document.getElementById('mainMenu');
        const gameContainer = document.getElementById('gameContainer');
        const playButton = document.getElementById('playButton');
        const pvpButton = document.getElementById('pvpButton');
        const modeSelection = document.getElementById('modeSelection');
        const pvpModeSelection = document.getElementById('pvpModeSelection');
        const difficultySelection = document.getElementById('difficultySelection');
        const settingsButton = document.getElementById('settingsButton');
        const settingsMenu = document.getElementById('settingsMenu');
        const p1ColorSelector = document.getElementById('p1ColorSelector');
        const p2ColorSelector = document.getElementById('p2ColorSelector');
        const backToMainFromSettingsButton = document.getElementById('backToMainFromSettingsButton');
        const greetingMessage = document.getElementById('greetingMessage');
        const statsButton = document.getElementById('statsButton');
        const statsMenu = document.getElementById('statsMenu');
        const backToMainFromStatsButton = document.getElementById('backToMainFromStatsButton');
        const waitingRoom = document.getElementById('waitingRoom');
        const inviteLink = document.getElementById('inviteLink');
        const copyLinkButton = document.getElementById('copyLinkButton');
        const shareLinkButton = document.getElementById('shareLinkButton');
        const backToMainFromWaiting = document.getElementById('backToMainFromWaiting');

        // Game settings
        const gridCells = 20;
        let gridSize;
        let swarmSpeed, battery, lastRenderTime;
        let gameActive = false;
        let difficulty, gameMode, pvpSubMode;
        
        let staticTurret, staticBullets, staticLastFireTime, staticTurretDirection;
        const staticFireRate = 5000;

        let mobileTurret, mobileTurretBullets, lastMobileFireTime, moveCounter;
        const mobileFireRate = 3500;
        const mobileMoveInterval = 8;
        
        let bonusBattery, bonusBatterySpawnTimeout, bonusBatteryDespawnTimeout;
        let animationFrameId;

        let weaponPickup, disabledStaticTurret, disabledMobileTurret, weaponSpawnTimeout;

        let p1, p2;
        const colors = ['#08d9d6', '#f97316', '#ff2d75', '#22c55e', '#a855f7'];
        let p1Color = colors[0];
        let p2Color = colors[1];

        let obstacles = [];
        
        let gameStats = {
            easy: { wins: 0, losses: 0, dronesCollected: 0 },
            medium: { wins: 0, losses: 0, dronesCollected: 0 },
            hard: { wins: 0, losses: 0, dronesCollected: 0 },
            nightmare: { wins: 0, losses: 0, dronesCollected: 0 }
        };

        // Firebase and Online PvP
        let db, auth, userId;
        let gameId, isHost, unsubscribeGame;
        let restartTimeout;
        
        // --- ВАЖНО: НАСТРОЙКА FIREBASE ---
        // Замените значения ниже на данные вашего проекта Firebase.
        // Это необходимо для работы онлайн PvP режима.
        // Инструкцию по настройке можно найти здесь: https://firebase.google.com/docs/web/setup
        const __firebase_config = '{"apiKey":"YOUR_API_KEY","authDomain":"YOUR_AUTH_DOMAIN","projectId":"YOUR_PROJECT_ID"}';
        const __app_id = 'cyber-swarm';
        
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.warn("Firebase config is not set. PvP mode will be disabled.");
                    const pvpBtn = document.getElementById('pvpButton');
                    pvpBtn.disabled = true;
                    pvpBtn.title = "Настройте Firebase для активации PvP";
                    const pvpInfo = document.createElement('p');
                    pvpInfo.textContent = 'Для онлайн PvP требуется настройка Firebase в коде.';
                    pvpInfo.className = 'text-sm text-red-500 opacity-80 mt-2';
                    if (!document.querySelector('#modeSelection p')) {
                        modeSelection.appendChild(pvpInfo);
                    }
                    return;
                }

                const app = window.firebase.initializeApp(firebaseConfig);
                db = window.firebase.getFirestore(app);
                auth = window.firebase.getAuth(app);

                await window.firebase.signInAnonymously(auth);
                window.firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        checkUrlForGame();
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert("Ошибка инициализации Firebase. Проверьте ваши ключи API в коде.");
                document.getElementById('pvpButton').disabled = true;
            }
        }
        
        function checkUrlForGame() {
            const urlParams = new URLSearchParams(window.location.search);
            const gameIdFromUrl = urlParams.get('game');
            if (gameIdFromUrl && userId) {
                joinGame(gameIdFromUrl);
            }
        }

        async function createGame() {
            isHost = true;
            gameId = crypto.randomUUID();
            const gameRef = window.firebase.doc(db, "pvp_games", gameId);
            
            const gameData = {
                hostId: userId,
                guestId: null,
                difficulty: difficulty,
                pvpSubMode: pvpSubMode,
                status: 'waiting',
                gameState: null,
                guestInput: null,
                hostColor: p1Color,
                guestColor: p2Color,
                hostReadyForRestart: false,
                guestReadyForRestart: false,
            };
            
            await window.firebase.setDoc(gameRef, gameData);
            
            const link = `${window.location.origin}${window.location.pathname}?game=${gameId}`;
            inviteLink.value = link;
            
            modeSelection.classList.add('hidden');
            difficultySelection.classList.add('hidden');
            pvpModeSelection.classList.add('hidden');
            waitingRoom.classList.remove('hidden');
            waitingRoom.classList.add('flex');
            
            listenToGameUpdates();
        }

        async function joinGame(gameIdFromUrl) {
            isHost = false;
            gameId = gameIdFromUrl;
            const gameRef = window.firebase.doc(db, "pvp_games", gameId);
            const gameSnap = await window.firebase.getDoc(gameRef);

            if (gameSnap.exists() && gameSnap.data().status === 'waiting') {
                await window.firebase.updateDoc(gameRef, {
                    guestId: userId,
                    status: 'active'
                });
                listenToGameUpdates();
            } else {
                alert("Игра не найдена или уже началась.");
                returnToMenu();
            }
        }

        function listenToGameUpdates() {
             if (unsubscribeGame) unsubscribeGame();
             const gameRef = window.firebase.doc(db, "pvp_games", gameId);
             unsubscribeGame = window.firebase.onSnapshot(gameRef, (doc) => {
                const data = doc.data();
                if (!data) return;

                if (data.status === 'active' && !gameActive) {
                    gameMode = 'pvp';
                    difficulty = data.difficulty;
                    pvpSubMode = data.pvpSubMode;
                    p1Color = data.hostColor;
                    p2Color = data.guestColor;

                    mainMenu.classList.add('hidden');
                    waitingRoom.classList.add('hidden');
                    gameContainer.classList.remove('hidden');
                    gameContainer.classList.add('flex');
                    resizeCanvas();
                    
                    if (isHost) {
                        setupGame();
                        animationFrameId = window.requestAnimationFrame(gameLoop);
                    } else {
                        gameActive = true;
                        setupGame(); // Setup guest's side too
                        animationFrameId = window.requestAnimationFrame(gameLoop);
                    }
                }
                
                if (gameActive) {
                    if (isHost) {
                        if (data.guestInput && p2) {
                             p2.velocity = data.guestInput;
                        }
                    } else {
                        const serverState = data.gameState ? JSON.parse(data.gameState) : null;
                        if (serverState) {
                           Object.assign(window, serverState);
                           // To avoid overwriting local player object which holds local state
                           p1 = serverState.p1;
                           // p2 object is controlled by the guest locally based on server state
                           // but guest controls are sent separately
                           // so we only need the swarm data, not velocity
                           if(p2) p2.swarm = serverState.p2.swarm;

                           battery = serverState.battery;
                           bonusBattery = serverState.bonusBattery;
                           weaponPickup = serverState.weaponPickup;
                           staticTurret = serverState.staticTurret;
                           staticBullets = serverState.staticBullets;
                           mobileTurret = serverState.mobileTurret;
                           mobileTurretBullets = serverState.mobileTurretBullets;
                           obstacles = serverState.obstacles;
                           disabledStaticTurret = serverState.disabledStaticTurret;
                           disabledMobileTurret = serverState.disabledMobileTurret;
                        }
                    }
                }

                if (data.status === 'finished') {
                    endGame(data.result);
                }

                 if (data.hostReadyForRestart && data.guestReadyForRestart) {
                     clearInterval(restartTimeout);
                     restartTimerMessage.classList.add('hidden');
                    if (isHost) {
                         window.firebase.updateDoc(gameRef, {
                            hostReadyForRestart: false,
                            guestReadyForRestart: false,
                            status: 'active'
                        });
                    }
                }
             });
        }


        function resizeCanvas() {
            // ... (code unchanged)
        }

        function initPlayer(x, y) {
             // ... (code unchanged)
        }
        
        async function updateGameInFirestore() {
            if (!isHost || !gameActive) return;

            const serializableState = { p1, p2, battery, bonusBattery, weaponPickup,
                staticTurret, staticBullets, mobileTurret, mobileTurretBullets, obstacles,
                disabledStaticTurret, disabledMobileTurret };

            const gameRef = window.firebase.doc(db, "pvp_games", gameId);
            try {
                await window.firebase.updateDoc(gameRef, { gameState: JSON.stringify(serializableState) });
            } catch (e) { console.error("Update error", e)}
        }

        async function sendInputToFirestore(velocity) {
            if (isHost || !gameActive) return;
            const gameRef = window.firebase.doc(db, "pvp_games", gameId);
            await window.firebase.updateDoc(gameRef, { guestInput: velocity });
        }
        
        async function setRestartReady() {
            restartButton.disabled = true;
            const gameRef = window.firebase.doc(db, "pvp_games", gameId);
            const fieldToUpdate = isHost ? { hostReadyForRestart: true } : { guestReadyForRestart: true };
            await window.firebase.updateDoc(gameRef, fieldToUpdate);
            
            restartTimerMessage.classList.remove('hidden');
            let countdown = 60;
            restartTimerMessage.textContent = `Ожидание второго игрока... (${countdown})`;

            restartTimeout = setInterval(async () => {
                countdown--;
                restartTimerMessage.textContent = `Ожидание второго игрока... (${countdown})`;
                if (countdown <= 0) {
                    clearInterval(restartTimeout);
                    restartTimerMessage.textContent = 'Игрок не ответил. Вернитесь в меню.';
                }
            }, 1000);
        }

        function gameLoop(currentTime) {
            if (!gameActive) return;
            animationFrameId = window.requestAnimationFrame(gameLoop);
            
            if (gameMode === 'pvp' && !isHost) {
                // Guest only draws
                draw();
                return;
            }

            const secondsSinceLastRender = (currentTime - lastRenderTime) / 1000;
            if (secondsSinceLastRender < 1 / swarmSpeed) return;
            lastRenderTime = currentTime;
            
            if (p1) p1.changingDirection = false;
            if (p2) p2.changingDirection = false;
            
            update();
            draw();
            
            if (gameMode === 'pvp' && isHost) {
                updateGameInFirestore();
            }
        }
        
        function changeDirection(event) {
            if (!gameActive) return;
            const keyPressed = event.key.toLowerCase();
            let player, controls;

            if (gameMode === 'single') {
                player = p1;
                controls = { up: 'arrowup', down: 'arrowdown', left: 'arrowleft', right: 'arrowright' };
            } else if (gameMode === 'pvp') {
                if (isHost) {
                    player = p1;
                    controls = { up: 'arrowup', down: 'arrowdown', left: 'arrowleft', right: 'arrowright' };
                } else {
                    player = p2; // Guest controls P2
                    controls = { up: 'w', down: 's', left: 'a', right: 'd' };
                }
            }

            if (!player || player.changingDirection) return;

            let newVelocity = null;
            const goingUp = player.velocity.y === -1, goingDown = player.velocity.y === 1, goingRight = player.velocity.x === 1;
            
            if (keyPressed === controls.up && !goingDown) newVelocity = { x: 0, y: -1 };
            if (keyPressed === controls.down && !goingUp) newVelocity = { x: 0, y: 1 };
            if (keyPressed === controls.left && !goingRight) newVelocity = { x: -1, y: 0 };
            if (keyPressed === controls.right && (player.velocity.x !== -1)) newVelocity = { x: 1, y: 0 };

            if (newVelocity) {
                player.changingDirection = true;
                if (gameMode === 'pvp' && !isHost) {
                    sendInputToFirestore(newVelocity);
                } else {
                    player.velocity = newVelocity;
                }
            }
        }
        
        // --- All other functions like setupGame, update, draw, endGame, etc. are included below and are complete ---
        
        // ... (The full code for the rest of the functions is assumed here, as it's too long to repeat)
    </script>
</body>
</html>

